# REQUIRES: aarch64, x86
RUN: split-file %s %t.dir && cd %t.dir

RUN: llvm-lib -machine:arm64ec -out:libtest.a -def:test.def
RUN: llvm-mc -triple=arm64ec-windows-gnu arm64ec.s -filetype=obj -o arm64ec.obj
RUN: llvm-mc -triple=arm64ec-windows-gnu x86_64.s -filetype=obj -o x86_64.obj

RUN: lld-link -machine:arm64ec -out:out.dll -dll -noentry x86_64.obj arm64ec libtest.a -lldmingw

RUN: llvm-readobj --coff-imports out.dll | FileCheck -check-prefix=IMPORTS %s
RUN: llvm-objdump -s out.dll  | FileCheck --check-prefix=CONTENTS %s

IMPORTS:      Import {
IMPORTS-NEXT:   Name: test.dll
IMPORTS-NEXT:   ImportLookupTableRVA: 0x3078
IMPORTS-NEXT:   ImportAddressTableRVA: 0x2000
IMPORTS-NEXT:   Symbol: variable (0)
IMPORTS-NEXT: }

Runtime pseudo reloc list header at 0x3008 consisting of 0x0, 0x0, 0x1.
First runtime pseudo reloc from x86_64 object file, with import from 0x2000,
applied at 0x5000 with a size of 32 bits. Second pseudo reloc from ARM64EC
object file with import from 0x2000, applied at 0x5008 with a size of 32 bits.
CONTENTS: Contents of section .rdata:
CONTENTS:  180003000 01100000 04000000 00000000 00000000
CONTENTS:  180003010 01000000 00200000 00500000 40000000
CONTENTS:  180003020 00200000 08500000 40000000 00000000

CONTENTS:      Contents of section .test:
CONTENTS-NEXT:  180005000 00200080 01000000 00200080 01000000
CONTENTS-NEXT:  180005010 08300080 01000000 2c300080 01000000

#--- arm64ec.s
    .text
    .global _pei386_runtime_relocator
_pei386_runtime_relocator:
    ret

    .section .test,"dr"
    .quad variable
    .quad __RUNTIME_PSEUDO_RELOC_LIST__
    .quad __RUNTIME_PSEUDO_RELOC_LIST_END__

#--- x86_64.s
    .section .test,"dr"
    .quad variable

#--- test.def
LIBRARY test.dll
EXPORTS
    variable DATA